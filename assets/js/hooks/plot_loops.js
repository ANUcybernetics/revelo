import cytoscape from "cytoscape";
import coseBilkent from "cytoscape-cose-bilkent";

cytoscape.use(coseBilkent);

const keySVG = encodeURIComponent(`
  <svg width="287" height="48" viewBox="0 0 287 48" fill="none" xmlns="http://www.w3.org/2000/svg">
  <rect width="287" height="48" rx="24" fill="#BAE6FD"/>
  <path fill-rule="evenodd" clip-rule="evenodd" d="M37 10C32.0294 10 28 14.0294 28 19C28 19.525 28.0451 20.0402 28.1317 20.5419C28.2213 21.0604 28.089 21.4967 27.8369 21.7489L19.1716 30.4142C18.4214 31.1644 18 32.1818 18 33.2426V37C18 37.5523 18.4477 38 19 38H24C24.5523 38 25 37.5523 25 37V35H27C27.5523 35 28 34.5523 28 34V32H30C30.2652 32 30.5196 31.8946 30.7071 31.7071L34.2511 28.1631C34.5033 27.911 34.9396 27.7787 35.4581 27.8683C35.9598 27.9549 36.475 28 37 28C41.9706 28 46 23.9706 46 19C46 14.0294 41.9706 10 37 10ZM37 14C36.4477 14 36 14.4477 36 15C36 15.5523 36.4477 16 37 16C38.6569 16 40 17.3431 40 19C40 19.5523 40.4477 20 41 20C41.5523 20 42 19.5523 42 19C42 16.2386 39.7614 14 37 14Z" fill="#082F49"/>
  <path d="M58.8295 15.0455L64.0114 29.7386H64.2159L69.3977 15.0455H71.6136L65.2045 32.5H63.0227L56.6136 15.0455H58.8295ZM76.6932 32.8068C75.8636 32.8068 75.1108 32.6506 74.4347 32.3381C73.7585 32.0199 73.2216 31.5625 72.8239 30.9659C72.4261 30.3636 72.2273 29.6364 72.2273 28.7841C72.2273 28.0341 72.375 27.4261 72.6705 26.9602C72.9659 26.4886 73.3608 26.1193 73.8551 25.8523C74.3494 25.5852 74.8949 25.3864 75.4915 25.2557C76.0938 25.1193 76.6989 25.0114 77.3068 24.9318C78.1023 24.8295 78.7472 24.7528 79.2415 24.7017C79.7415 24.6449 80.1051 24.5511 80.3324 24.4205C80.5653 24.2898 80.6818 24.0625 80.6818 23.7386V23.6705C80.6818 22.8295 80.4517 22.1761 79.9915 21.7102C79.5369 21.2443 78.8466 21.0114 77.9205 21.0114C76.9602 21.0114 76.2074 21.2216 75.6619 21.642C75.1165 22.0625 74.733 22.5114 74.5114 22.9886L72.6023 22.3068C72.9432 21.5114 73.3977 20.892 73.9659 20.4489C74.5398 20 75.1648 19.6875 75.8409 19.5114C76.5227 19.3295 77.1932 19.2386 77.8523 19.2386C78.2727 19.2386 78.7557 19.2898 79.3011 19.392C79.8523 19.4886 80.3835 19.6903 80.8949 19.9972C81.4119 20.304 81.8409 20.767 82.1818 21.3864C82.5227 22.0057 82.6932 22.8352 82.6932 23.875V32.5H80.6818V30.7273H80.5795C80.4432 31.0114 80.2159 31.3153 79.8977 31.6392C79.5795 31.9631 79.1563 32.2386 78.6278 32.4659C78.0994 32.6932 77.4545 32.8068 76.6932 32.8068ZM77 31C77.7955 31 78.4659 30.8438 79.0114 30.5312C79.5625 30.2188 79.9773 29.8153 80.2557 29.321C80.5398 28.8267 80.6818 28.3068 80.6818 27.7614V25.9205C80.5966 26.0227 80.4091 26.1165 80.1193 26.2017C79.8352 26.2812 79.5057 26.3523 79.1307 26.4148C78.7614 26.4716 78.4006 26.5227 78.0483 26.5682C77.7017 26.608 77.4205 26.642 77.2045 26.6705C76.6818 26.7386 76.1932 26.8494 75.7386 27.0028C75.2898 27.1506 74.9261 27.375 74.6477 27.6761C74.375 27.9716 74.2386 28.375 74.2386 28.8864C74.2386 29.5852 74.4972 30.1136 75.0142 30.4716C75.5369 30.8239 76.1989 31 77 31ZM86.3643 32.5V19.4091H88.3075V21.3864H88.4439C88.6825 20.7386 89.1143 20.2131 89.7393 19.8097C90.3643 19.4062 91.0689 19.2045 91.853 19.2045C92.0007 19.2045 92.1854 19.2074 92.407 19.2131C92.6286 19.2187 92.7962 19.2273 92.9098 19.2386V21.2841C92.8416 21.267 92.6854 21.2415 92.4411 21.2074C92.2024 21.1676 91.9496 21.1477 91.6825 21.1477C91.0462 21.1477 90.478 21.2812 89.978 21.5483C89.4837 21.8097 89.0916 22.1733 88.8018 22.6392C88.5178 23.0994 88.3757 23.625 88.3757 24.2159V32.5H86.3643ZM95.294 32.5V19.4091H97.3054V32.5H95.294ZM96.3168 17.2273C95.9247 17.2273 95.5866 17.0938 95.3026 16.8267C95.0241 16.5597 94.8849 16.2386 94.8849 15.8636C94.8849 15.4886 95.0241 15.1676 95.3026 14.9006C95.5866 14.6335 95.9247 14.5 96.3168 14.5C96.7088 14.5 97.044 14.6335 97.3224 14.9006C97.6065 15.1676 97.7486 15.4886 97.7486 15.8636C97.7486 16.2386 97.6065 16.5597 97.3224 16.8267C97.044 17.0938 96.7088 17.2273 96.3168 17.2273ZM104.842 32.8068C104.012 32.8068 103.259 32.6506 102.583 32.3381C101.907 32.0199 101.37 31.5625 100.972 30.9659C100.575 30.3636 100.376 29.6364 100.376 28.7841C100.376 28.0341 100.523 27.4261 100.819 26.9602C101.114 26.4886 101.509 26.1193 102.004 25.8523C102.498 25.5852 103.043 25.3864 103.64 25.2557C104.242 25.1193 104.847 25.0114 105.455 24.9318C106.251 24.8295 106.896 24.7528 107.39 24.7017C107.89 24.6449 108.254 24.5511 108.481 24.4205C108.714 24.2898 108.83 24.0625 108.83 23.7386V23.6705C108.83 22.8295 108.6 22.1761 108.14 21.7102C107.685 21.2443 106.995 21.0114 106.069 21.0114C105.109 21.0114 104.356 21.2216 103.81 21.642C103.265 22.0625 102.881 22.5114 102.66 22.9886L100.751 22.3068C101.092 21.5114 101.546 20.892 102.114 20.4489C102.688 20 103.313 19.6875 103.989 19.5114C104.671 19.3295 105.342 19.2386 106.001 19.2386C106.421 19.2386 106.904 19.2898 107.45 19.392C108.001 19.4886 108.532 19.6903 109.043 19.9972C109.56 20.304 109.989 20.767 110.33 21.3864C110.671 22.0057 110.842 22.8352 110.842 23.875V32.5H108.83V30.7273H108.728C108.592 31.0114 108.364 31.3153 108.046 31.6392C107.728 31.9631 107.305 32.2386 106.776 32.4659C106.248 32.6932 105.603 32.8068 104.842 32.8068ZM105.148 31C105.944 31 106.614 30.8438 107.16 30.5312C107.711 30.2188 108.126 29.8153 108.404 29.321C108.688 28.8267 108.83 28.3068 108.83 27.7614V25.9205C108.745 26.0227 108.558 26.1165 108.268 26.2017C107.984 26.2812 107.654 26.3523 107.279 26.4148C106.91 26.4716 106.549 26.5227 106.197 26.5682C105.85 26.608 105.569 26.642 105.353 26.6705C104.83 26.7386 104.342 26.8494 103.887 27.0028C103.438 27.1506 103.075 27.375 102.796 27.6761C102.523 27.9716 102.387 28.375 102.387 28.8864C102.387 29.5852 102.646 30.1136 103.163 30.4716C103.685 30.8239 104.347 31 105.148 31ZM114.786 32.5V15.0455H116.797V21.4886H116.967C117.115 21.2614 117.32 20.9716 117.581 20.6193C117.848 20.2614 118.229 19.9432 118.723 19.6648C119.223 19.3807 119.899 19.2386 120.751 19.2386C121.854 19.2386 122.825 19.5142 123.666 20.0653C124.507 20.6165 125.163 21.3977 125.635 22.4091C126.107 23.4205 126.342 24.6136 126.342 25.9886C126.342 27.375 126.107 28.5767 125.635 29.5938C125.163 30.6051 124.51 31.3892 123.675 31.946C122.839 32.4972 121.876 32.7727 120.786 32.7727C119.945 32.7727 119.271 32.6335 118.766 32.3551C118.26 32.071 117.871 31.75 117.598 31.392C117.325 31.0284 117.115 30.7273 116.967 30.4886H116.729V32.5H114.786ZM116.763 25.9545C116.763 26.9432 116.908 27.8153 117.197 28.571C117.487 29.321 117.911 29.9091 118.467 30.3352C119.024 30.7557 119.706 30.9659 120.513 30.9659C121.354 30.9659 122.055 30.7443 122.618 30.3011C123.186 29.8523 123.612 29.25 123.896 28.4943C124.186 27.733 124.331 26.8864 124.331 25.9545C124.331 25.0341 124.189 24.2045 123.905 23.4659C123.626 22.7216 123.203 22.1335 122.635 21.7017C122.072 21.2642 121.365 21.0455 120.513 21.0455C119.695 21.0455 119.007 21.2528 118.45 21.6676C117.893 22.0767 117.473 22.6506 117.189 23.3892C116.905 24.1222 116.763 24.9773 116.763 25.9545ZM131.43 15.0455V32.5H129.419V15.0455H131.43ZM140.603 32.7727C139.342 32.7727 138.254 32.4943 137.339 31.9375C136.43 31.375 135.728 30.5909 135.234 29.5852C134.745 28.5739 134.501 27.3977 134.501 26.0568C134.501 24.7159 134.745 23.5341 135.234 22.5114C135.728 21.483 136.415 20.6818 137.296 20.108C138.183 19.5284 139.217 19.2386 140.398 19.2386C141.08 19.2386 141.754 19.3523 142.418 19.5795C143.083 19.8068 143.688 20.1761 144.234 20.6875C144.779 21.1932 145.214 21.8636 145.538 22.6989C145.862 23.5341 146.023 24.5625 146.023 25.7841V26.6364H135.933V24.8977H143.978C143.978 24.1591 143.83 23.5 143.535 22.9205C143.245 22.3409 142.83 21.8835 142.29 21.5483C141.756 21.2131 141.126 21.0455 140.398 21.0455C139.597 21.0455 138.904 21.2443 138.319 21.642C137.739 22.0341 137.293 22.5455 136.981 23.1761C136.668 23.8068 136.512 24.483 136.512 25.2045V26.3636C136.512 27.3523 136.683 28.1903 137.023 28.8778C137.37 29.5597 137.85 30.0795 138.464 30.4375C139.077 30.7898 139.79 30.9659 140.603 30.9659C141.131 30.9659 141.609 30.892 142.035 30.7443C142.467 30.5909 142.839 30.3636 143.151 30.0625C143.464 29.7557 143.705 29.375 143.876 28.9205L145.819 29.4659C145.614 30.125 145.271 30.7045 144.788 31.2045C144.305 31.6989 143.708 32.0852 142.998 32.3636C142.288 32.6364 141.489 32.7727 140.603 32.7727ZM161.151 32.7727C159.969 32.7727 158.933 32.4915 158.04 31.929C157.154 31.3665 156.461 30.5795 155.961 29.5682C155.467 28.5568 155.219 27.375 155.219 26.0227C155.219 24.6591 155.467 23.4687 155.961 22.4517C156.461 21.4347 157.154 20.6449 158.04 20.0824C158.933 19.5199 159.969 19.2386 161.151 19.2386C162.333 19.2386 163.367 19.5199 164.254 20.0824C165.146 20.6449 165.839 21.4347 166.333 22.4517C166.833 23.4687 167.083 24.6591 167.083 26.0227C167.083 27.375 166.833 28.5568 166.333 29.5682C165.839 30.5795 165.146 31.3665 164.254 31.929C163.367 32.4915 162.333 32.7727 161.151 32.7727ZM161.151 30.9659C162.049 30.9659 162.788 30.7358 163.367 30.2756C163.947 29.8153 164.376 29.2102 164.654 28.4602C164.933 27.7102 165.072 26.8977 165.072 26.0227C165.072 25.1477 164.933 24.3324 164.654 23.5767C164.376 22.821 163.947 22.2102 163.367 21.7443C162.788 21.2784 162.049 21.0455 161.151 21.0455C160.254 21.0455 159.515 21.2784 158.935 21.7443C158.356 22.2102 157.927 22.821 157.648 23.5767C157.37 24.3324 157.231 25.1477 157.231 26.0227C157.231 26.8977 157.37 27.7102 157.648 28.4602C157.927 29.2102 158.356 29.8153 158.935 30.2756C159.515 30.7358 160.254 30.9659 161.151 30.9659ZM175.983 19.4091V21.1136H168.926V19.4091H175.983ZM171.04 32.5V17.6023C171.04 16.8523 171.216 16.2273 171.568 15.7273C171.92 15.2273 172.378 14.8523 172.94 14.6023C173.503 14.3523 174.097 14.2273 174.722 14.2273C175.216 14.2273 175.619 14.267 175.932 14.3466C176.244 14.4261 176.477 14.5 176.631 14.5682L176.051 16.3068C175.949 16.2727 175.807 16.2301 175.625 16.179C175.449 16.1278 175.216 16.1023 174.926 16.1023C174.261 16.1023 173.781 16.2699 173.486 16.6051C173.196 16.9403 173.051 17.4318 173.051 18.0795V32.5H171.04ZM187.938 15.0455V32.5H185.825V15.0455H187.938ZM193.915 24.625V32.5H191.903V19.4091H193.847V21.4545H194.017C194.324 20.7898 194.79 20.2557 195.415 19.8523C196.04 19.4432 196.847 19.2386 197.835 19.2386C198.722 19.2386 199.497 19.4205 200.162 19.7841C200.827 20.142 201.344 20.6875 201.713 21.4205C202.082 22.1477 202.267 23.0682 202.267 24.1818V32.5H200.256V24.3182C200.256 23.2898 199.989 22.4886 199.455 21.9148C198.92 21.3352 198.188 21.0455 197.256 21.0455C196.614 21.0455 196.04 21.1847 195.534 21.4631C195.034 21.7415 194.639 22.1477 194.349 22.6818C194.06 23.2159 193.915 23.8636 193.915 24.625ZM211.636 19.4091V21.1136H204.852V19.4091H211.636ZM206.829 16.2727H208.84V28.75C208.84 29.3182 208.923 29.7443 209.087 30.0284C209.258 30.3068 209.474 30.4943 209.735 30.5909C210.002 30.6818 210.283 30.7273 210.579 30.7273C210.8 30.7273 210.982 30.7159 211.124 30.6932C211.266 30.6648 211.38 30.642 211.465 30.625L211.874 32.4318C211.738 32.483 211.548 32.5341 211.303 32.5852C211.059 32.642 210.749 32.6705 210.374 32.6705C209.806 32.6705 209.249 32.5483 208.704 32.304C208.164 32.0597 207.715 31.6875 207.357 31.1875C207.005 30.6875 206.829 30.0568 206.829 29.2955V16.2727ZM220.009 32.7727C218.748 32.7727 217.66 32.4943 216.745 31.9375C215.836 31.375 215.134 30.5909 214.64 29.5852C214.151 28.5739 213.907 27.3977 213.907 26.0568C213.907 24.7159 214.151 23.5341 214.64 22.5114C215.134 21.483 215.822 20.6818 216.702 20.108C217.589 19.5284 218.623 19.2386 219.805 19.2386C220.487 19.2386 221.16 19.3523 221.825 19.5795C222.489 19.8068 223.094 20.1761 223.64 20.6875C224.185 21.1932 224.62 21.8636 224.944 22.6989C225.268 23.5341 225.43 24.5625 225.43 25.7841V26.6364H215.339V24.8977H223.384C223.384 24.1591 223.237 23.5 222.941 22.9205C222.651 22.3409 222.237 21.8835 221.697 21.5483C221.163 21.2131 220.532 21.0455 219.805 21.0455C219.004 21.0455 218.31 21.2443 217.725 21.642C217.146 22.0341 216.7 22.5455 216.387 23.1761C216.075 23.8068 215.918 24.483 215.918 25.2045V26.3636C215.918 27.3523 216.089 28.1903 216.43 28.8778C216.776 29.5597 217.256 30.0795 217.87 30.4375C218.484 30.7898 219.197 30.9659 220.009 30.9659C220.538 30.9659 221.015 30.892 221.441 30.7443C221.873 30.5909 222.245 30.3636 222.558 30.0625C222.87 29.7557 223.112 29.375 223.282 28.9205L225.225 29.4659C225.021 30.125 224.677 30.7045 224.194 31.2045C223.711 31.6989 223.114 32.0852 222.404 32.3636C221.694 32.6364 220.896 32.7727 220.009 32.7727ZM228.489 32.5V19.4091H230.433V21.3864H230.569C230.808 20.7386 231.239 20.2131 231.864 19.8097C232.489 19.4062 233.194 19.2045 233.978 19.2045C234.126 19.2045 234.31 19.2074 234.532 19.2131C234.754 19.2187 234.921 19.2273 235.035 19.2386V21.2841C234.967 21.267 234.81 21.2415 234.566 21.2074C234.327 21.1676 234.075 21.1477 233.808 21.1477C233.171 21.1477 232.603 21.2812 232.103 21.5483C231.609 21.8097 231.217 22.1733 230.927 22.6392C230.643 23.0994 230.501 23.625 230.501 24.2159V32.5H228.489ZM242.509 32.7727C241.248 32.7727 240.16 32.4943 239.245 31.9375C238.336 31.375 237.634 30.5909 237.14 29.5852C236.651 28.5739 236.407 27.3977 236.407 26.0568C236.407 24.7159 236.651 23.5341 237.14 22.5114C237.634 21.483 238.322 20.6818 239.202 20.108C240.089 19.5284 241.123 19.2386 242.305 19.2386C242.987 19.2386 243.66 19.3523 244.325 19.5795C244.989 19.8068 245.594 20.1761 246.14 20.6875C246.685 21.1932 247.12 21.8636 247.444 22.6989C247.768 23.5341 247.93 24.5625 247.93 25.7841V26.6364H237.839V24.8977H245.884C245.884 24.1591 245.737 23.5 245.441 22.9205C245.151 22.3409 244.737 21.8835 244.197 21.5483C243.663 21.2131 243.032 21.0455 242.305 21.0455C241.504 21.0455 240.81 21.2443 240.225 21.642C239.646 22.0341 239.2 22.5455 238.887 23.1761C238.575 23.8068 238.418 24.483 238.418 25.2045V26.3636C238.418 27.3523 238.589 28.1903 238.93 28.8778C239.276 29.5597 239.756 30.0795 240.37 30.4375C240.984 30.7898 241.697 30.9659 242.509 30.9659C243.038 30.9659 243.515 30.892 243.941 30.7443C244.373 30.5909 244.745 30.3636 245.058 30.0625C245.37 29.7557 245.612 29.375 245.782 28.9205L247.725 29.4659C247.521 30.125 247.177 30.7045 246.694 31.2045C246.211 31.6989 245.614 32.0852 244.904 32.3636C244.194 32.6364 243.396 32.7727 242.509 32.7727ZM260.262 22.3409L258.455 22.8523C258.342 22.5511 258.174 22.2585 257.952 21.9744C257.737 21.6847 257.441 21.446 257.066 21.2585C256.691 21.071 256.211 20.9773 255.626 20.9773C254.825 20.9773 254.157 21.1619 253.623 21.5312C253.094 21.8949 252.83 22.358 252.83 22.9205C252.83 23.4205 253.012 23.8153 253.376 24.1051C253.739 24.3949 254.308 24.6364 255.08 24.8295L257.023 25.3068C258.194 25.5909 259.066 26.0256 259.64 26.6108C260.214 27.1903 260.501 27.9375 260.501 28.8523C260.501 29.6023 260.285 30.2727 259.853 30.8636C259.427 31.4545 258.83 31.9205 258.063 32.2614C257.296 32.6023 256.404 32.7727 255.387 32.7727C254.052 32.7727 252.947 32.483 252.072 31.9034C251.197 31.3239 250.643 30.4773 250.41 29.3636L252.319 28.8864C252.501 29.5909 252.844 30.1193 253.35 30.4716C253.862 30.8239 254.529 31 255.353 31C256.29 31 257.035 30.8011 257.586 30.4034C258.143 30 258.421 29.517 258.421 28.9545C258.421 28.5 258.262 28.1193 257.944 27.8125C257.626 27.5 257.137 27.267 256.478 27.1136L254.296 26.6023C253.097 26.3182 252.217 25.8778 251.654 25.2812C251.097 24.679 250.819 23.9261 250.819 23.0227C250.819 22.2841 251.026 21.6307 251.441 21.0625C251.862 20.4943 252.433 20.0483 253.154 19.7244C253.881 19.4006 254.705 19.2386 255.626 19.2386C256.921 19.2386 257.938 19.5227 258.677 20.0909C259.421 20.6591 259.95 21.4091 260.262 22.3409ZM269.222 19.4091V21.1136H262.438V19.4091H269.222ZM264.415 16.2727H266.426V28.75C266.426 29.3182 266.509 29.7443 266.673 30.0284C266.844 30.3068 267.06 30.4943 267.321 30.5909C267.588 30.6818 267.869 30.7273 268.165 30.7273C268.386 30.7273 268.568 30.7159 268.71 30.6932C268.852 30.6648 268.966 30.642 269.051 30.625L269.46 32.4318C269.324 32.483 269.134 32.5341 268.889 32.5852C268.645 32.642 268.335 32.6705 267.96 32.6705C267.392 32.6705 266.835 32.5483 266.29 32.304C265.75 32.0597 265.301 31.6875 264.943 31.1875C264.591 30.6875 264.415 30.0568 264.415 29.2955V16.2727Z" fill="#082F49"/>
  </svg>

`);

function updateNodeStyles(selectedLoop, loops, cy, relationships) {
  //TODO: Use cytoscape selectors to improve performance
  if (!cy || !selectedLoop) {
    cy?.elements().style({
      opacity: 1,
    });
    return;
  }

  cy.elements().style({
    opacity: 0,
  });

  const selectedLoopNodes = new Set();
  const selectedLoopRelationships = relationships.filter(
    (rel) =>
      rel.group === "edges" &&
      loops.some(
        (loop) =>
          loop.id === selectedLoop &&
          loop.influence_relationships.some(
            (loopRel) => loopRel.id === rel.data.id,
          ),
      ),
  );

  selectedLoopRelationships.forEach((rel) => {
    selectedLoopNodes.add(rel.data.source);
    selectedLoopNodes.add(rel.data.target);
  });

  const selectedLoopRelationshipIds = new Set(
    selectedLoopRelationships.map((rel) => rel.data.id),
  );

  cy.elements().forEach((element) => {
    if (
      selectedLoopRelationshipIds.has(element.id()) ||
      selectedLoopNodes.has(element.id())
    ) {
      element.style({
        opacity: 1,
      });
    }
  });
}

export const PlotLoops = {
  mounted() {
    const savedPositions = localStorage.getItem("nodePositions");
    const positions = savedPositions ? JSON.parse(savedPositions) : null;

    this.cy = cytoscape({
      container: this.el,
      elements: JSON.parse(this.el.dataset.elements || "[]"),
      style: [
        {
          selector: "node",
          style: {
            "background-color": "#ffffff",
            "background-image": function (ele) {
              return ele.data("isKey")
                ? `data:image/svg+xml;utf8,${keySVG}`
                : "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7";
            },
            "background-width": function (ele) {
              return ele.data("isKey") ? "150px" : "0";
            },
            "background-height": function (ele) {
              return ele.data("isKey") ? "25px" : "0";
            },
            "background-position-x": function (ele) {
              return ele.data("isKey") ? "4px" : "0";
            },
            "background-position-y": function (ele) {
              return ele.data("isKey") ? "4px" : "0";
            },
            "background-fit": "none",
            "background-clip": "none",
            "border-width": "1px",
            "border-color": "#e2e8f0",
            "border-style": "solid",
            label: "data(label)",
            "text-wrap": "wrap",
            "text-max-width": "250px",
            "font-size": "24px",
            "text-valign": "center",
            "text-halign": "center",
            "text-outline-width": 0,
            padding: "18px",
            shape: "round-rectangle",
            width: "300px",
            height: function (ele) {
              return ele.data("label").length * 0.5 + 30;
            },
            "text-margin-y": function (ele) {
              return ele.data("isKey") ? 15 : 0;
            },
            "text-outline-opacity": 1,
            "font-family": "Inter",
            "font-weight": function (ele) {
              return ele.data("isKey") ? "600" : "400";
            },
          },
        },
        {
          selector: "edge",
          style: {
            width: 3,
            "line-color": "data(relation)",
            "target-arrow-color": "data(relation)",
            "target-arrow-shape": "triangle",
            "curve-style": "unbundled-bezier",
          },
        },
        {
          selector: 'edge[relation = "direct"]',
          style: {
            "line-color": "#0284C7",
            "target-arrow-color": "#0284C7",
          },
        },
        {
          selector: 'edge[relation = "inverse"]',
          style: {
            "line-color": "#C2410C",
            "target-arrow-color": "#C2410C",
          },
        },
      ],
      layout: positions
        ? {
            name: "preset",
            positions: positions,
          }
        : {
            name: "cose-bilkent",
            quality: "proof",
            animate: false,
            randomize: true,
            nodeDimensionsIncludeLabels: true,
            fit: true,
            padding: 50,
            nodeRepulsion: 8000,
            idealEdgeLength: 200,
            edgeElasticity: 0.45,
            nestingFactor: 0.1,
            gravity: 0.25,
            numIter: 2500,
            tile: false,
            tilingPaddingVertical: 20,
            tilingPaddingHorizontal: 20,
            gravityRangeCompound: 1.5,
            gravityCompound: 1.0,
            gravityRange: 3.8,
            initialEnergyOnIncremental: 0.5,
          },
    });

    // Save positions when nodes are moved
    this.cy.on("position", "node", () => {
      const positions = {};
      this.cy.nodes().forEach((node) => {
        positions[node.id()] = node.position();
      });
      localStorage.setItem("nodePositions", JSON.stringify(positions));
    });
  },

  updated() {
    const elements = JSON.parse(this.el.dataset.elements || "[]");
    const layout = JSON.parse(this.el.dataset.layout || "{}");
    const selectedLoop = this.el.dataset.selectedLoop;
    const loops = JSON.parse(this.el.dataset.loops || "[]");

    updateNodeStyles(
      selectedLoop,
      loops,
      this.cy,
      elements.filter((ele) => ele.group === "edges"),
    );
  },

  destroyed() {
    if (this.cy) {
      this.cy.destroy();
    }
  },
};

export default PlotLoops;
